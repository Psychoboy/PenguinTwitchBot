@page "/giveaway"
@attribute [Authorize(Roles = "Streamer")]
@using Microsoft.AspNetCore.SignalR.Client
@using DotNetTwitchBot.Bot.Models.Giveaway
@inject DotNetTwitchBot.Bot.Commands.Features.GiveawayFeature GiveawayFeature;
@inject NavigationManager Navigation

<PageTitle>Giveaway</PageTitle>
<MudContainer MaxWidth="MaxWidth.False">
    <MudGrid>
        <MudItem sm="6">
            <MudPaper Class="pa-8 ma-2" Outlined="true">
                <MudText Typo="Typo.h2">Prize</MudText>
                <MudText Typo="Typo.h3">@prize</MudText>
            </MudPaper>
        </MudItem>
        <MudItem sm="6">
            <MudPaper Class="pa-8 ma-2" Outlined="true">
                <MudText Typo="Typo.h2">Winners</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Close">Close</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Draw">Draw</MudButton>
                @foreach (var winner in winners)
                {
                    @if (firstDraw == false)
                    {
                        <MudDivider />
                    }
                    { firstDraw = false; }

                    <MudText Typo="Typo.h3">@winner.Username</MudText>
                    <MudText Typo="Typo.h4">@winner.Prize</MudText>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

</MudContainer>

@if (pastWinners == null)
{
    <MudAlert Severity="Severity.Info">Loading...</MudAlert>
}
else
{
    <MudPaper Class="pa-16 ma-2" Outlined="true">
        <MudText Typo="Typo.h3">Past Winners</MudText>
        <MudTable Items="@pastWinners">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Prize</MudTh>
                <MudTh>Date</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">@context.Username</MudTd>
                <MudTd DataLabel="Prize">@context.Prize</MudTd>
                <MudTd DataLabel="Date">@context.WinningDate.ToShortDateString()</MudTd>
            </RowTemplate>
        </MudTable>
    </MudPaper>
}
@code {
    private List<GiveawayWinner> winners = new List<GiveawayWinner>();
    private List<GiveawayWinner>? pastWinners;
    private string prize = "";
    private HubConnection? hubConnection;
    private bool firstDraw = true;
    protected override async Task OnInitializedAsync()
    {
        pastWinners = await GiveawayFeature.PastWinners();
        prize = await GiveawayFeature.GetPrize();
        
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender == false) return;
        hubConnection = new HubConnectionBuilder()
        .WithUrl(Navigation.ToAbsoluteUri("/giveawayhub")).Build();
        hubConnection.On<List<GiveawayWinner>>("Winners", (Winners) =>
        {
            winners = Winners;
            InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string>("Prize", (Prize) =>
        {
            prize = Prize;
            InvokeAsync(StateHasChanged);
        });
        await hubConnection.StartAsync();
    }

    private async Task Draw()
    {
        await GiveawayFeature.Draw();
        pastWinners = await GiveawayFeature.PastWinners();
        StateHasChanged();
    }

    private async Task Close()
    {
        await GiveawayFeature.Close();
    }
}